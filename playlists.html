<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قوائم التشغيل - Audio Hosting</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/player.css">
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="navbar-brand">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18V5l12-2v13" />
                    <circle cx="6" cy="18" r="3" />
                    <circle cx="18" cy="16" r="3" />
                </svg>
                Audio Hosting
            </a>
            <ul class="nav-links">
                <li><a href="index.html" class="nav-link">الرئيسية</a></li>
                <li><a href="upload.html" class="nav-link">إضافة صوت</a></li>
                <li><a href="embed.html" class="nav-link">كود التضمين</a></li>
                <li><a href="playlists.html" class="nav-link active">قوائم التشغيل</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div class="flex items-center justify-between mb-lg">
                <div>
                    <h1>قوائم التشغيل</h1>
                    <p class="text-muted">إدارة قوائم التشغيل الخاصة بك</p>
                </div>
                <button class="btn btn-primary" onclick="showCreateModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <line x1="12" y1="5" x2="12" y2="19" />
                        <line x1="5" y1="12" x2="19" y2="12" />
                    </svg>
                    قائمة جديدة
                </button>
            </div>

            <div class="grid grid-3" id="playlistsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>

            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-state-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="8" y1="6" x2="21" y2="6" />
                        <line x1="8" y1="12" x2="21" y2="12" />
                        <line x1="8" y1="18" x2="21" y2="18" />
                        <line x1="3" y1="6" x2="3.01" y2="6" />
                    </svg>
                </div>
                <h3 class="empty-state-title">لا توجد قوائم تشغيل</h3>
                <p class="empty-state-text">أنشئ قائمة تشغيل لتنظيم ملفاتك الصوتية</p>
                <button class="btn btn-primary mt-lg" onclick="showCreateModal()">إنشاء قائمة</button>
            </div>
        </div>
    </main>

    <!-- Create Modal -->
    <div class="modal" id="createModal">
        <div class="modal-overlay" onclick="Modal.hide('createModal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>إنشاء قائمة تشغيل جديدة</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">اسم القائمة</label>
                    <input type="text" class="form-control" id="playlistName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">الوصف (اختياري)</label>
                    <textarea class="form-control" id="playlistDesc"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="Modal.hide('createModal')">إلغاء</button>
                <button class="btn btn-primary" onclick="createPlaylist()">إنشاء</button>
            </div>
        </div>
    </div>

    <!-- View Modal -->
    <div class="modal" id="viewModal">
        <div class="modal-overlay" onclick="Modal.hide('viewModal')"></div>
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="viewModalTitle">قائمة التشغيل</h3>
            </div>
            <div class="modal-body">
                <div id="playlistItems"></div>

                <div class="mt-lg">
                    <h4 class="mb-md">إضافة ملف صوتي</h4>
                    <div class="flex gap-sm">
                        <select class="form-control" id="addAudioSelect" style="flex: 1;">
                            <option value="">-- اختر ملف صوتي --</option>
                        </select>
                        <button class="btn btn-primary" onclick="addToPlaylist()">إضافة</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="Modal.hide('viewModal')">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Player -->
    <div id="playerContainer"
        style="position: fixed; bottom: 0; left: 0; right: 0; padding: 1rem; background: rgba(15, 15, 35, 0.95); border-top: 1px solid rgba(99, 102, 241, 0.2); display: none; z-index: 50;">
    </div>

    <script src="config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    <script src="js/player.js"></script>
    <script>
        let playlists = [];
        let audios = [];
        let currentPlaylist = null;
        let player = null;

        async function loadPlaylists() {
            try {
                const response = await api.getPlaylists();
                playlists = response.playlists || [];
                renderPlaylists();
            } catch (error) {
                Toast.error('فشل تحميل قوائم التشغيل');
            }
        }

        async function loadAudios() {
            try {
                const response = await api.getAudios();
                audios = response.audios || [];
            } catch (error) {
                console.error(error);
            }
        }

        function renderPlaylists() {
            const grid = document.getElementById('playlistsGrid');
            const empty = document.getElementById('emptyState');

            if (playlists.length === 0) {
                grid.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            grid.innerHTML = playlists.map(p => `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">${p.name}</h3>
                        <span class="text-muted">${p.item_count || 0} ملف</span>
                    </div>
                    <p class="text-muted mb-md">${p.description || 'بدون وصف'}</p>
                    <div class="flex gap-sm">
                        <button class="btn btn-primary btn-sm" onclick="viewPlaylist(${p.id})">عرض</button>
                        <button class="btn btn-ghost btn-sm" onclick="playPlaylist(${p.id})">تشغيل</button>
                        <button class="btn btn-ghost btn-sm" onclick="deletePlaylist(${p.id})">حذف</button>
                    </div>
                </div>
            `).join('');
        }

        function showCreateModal() {
            document.getElementById('playlistName').value = '';
            document.getElementById('playlistDesc').value = '';
            Modal.show('createModal');
        }

        async function createPlaylist() {
            const name = document.getElementById('playlistName').value;
            const description = document.getElementById('playlistDesc').value;

            if (!name) {
                Toast.error('الرجاء إدخال اسم القائمة');
                return;
            }

            try {
                await api.createPlaylist({ name, description });
                Toast.success('تم إنشاء القائمة');
                Modal.hide('createModal');
                loadPlaylists();
            } catch (error) {
                Toast.error('فشل إنشاء القائمة');
            }
        }

        async function viewPlaylist(id) {
            try {
                const response = await api.getPlaylist(id);
                currentPlaylist = response.playlist;

                document.getElementById('viewModalTitle').textContent = currentPlaylist.name;

                const items = currentPlaylist.items || [];
                document.getElementById('playlistItems').innerHTML = items.length === 0
                    ? '<p class="text-muted text-center">لا توجد ملفات صوتية في هذه القائمة</p>'
                    : items.map(item => `
                        <div class="flex items-center gap-md mb-md" style="padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <span>${item.title}</span>
                            <span class="text-muted" style="margin-right: auto;">${item.artist || ''}</span>
                            <button class="btn btn-ghost btn-sm" onclick="removeFromPlaylist(${item.audio_id})">حذف</button>
                        </div>
                    `).join('');

                // Populate audio select
                const select = document.getElementById('addAudioSelect');
                select.innerHTML = '<option value="">-- اختر ملف صوتي --</option>';
                audios.forEach(a => {
                    const option = document.createElement('option');
                    option.value = a.id;
                    option.textContent = a.title;
                    select.appendChild(option);
                });

                Modal.show('viewModal');
            } catch (error) {
                Toast.error('فشل تحميل القائمة');
            }
        }

        async function addToPlaylist() {
            const audioId = document.getElementById('addAudioSelect').value;
            if (!audioId || !currentPlaylist) return;

            try {
                await api.addToPlaylist(currentPlaylist.id, audioId);
                Toast.success('تم إضافة الملف');
                viewPlaylist(currentPlaylist.id);
                loadPlaylists();
            } catch (error) {
                Toast.error(error.message || 'فشل إضافة الملف');
            }
        }

        async function removeFromPlaylist(audioId) {
            if (!currentPlaylist) return;

            try {
                await api.removeFromPlaylist(currentPlaylist.id, audioId);
                Toast.success('تم إزالة الملف');
                viewPlaylist(currentPlaylist.id);
                loadPlaylists();
            } catch (error) {
                Toast.error('فشل إزالة الملف');
            }
        }

        async function playPlaylist(id) {
            try {
                const response = await api.getPlaylist(id);
                const items = response.playlist.items || [];

                if (items.length === 0) {
                    Toast.warning('القائمة فارغة');
                    return;
                }

                const container = document.getElementById('playerContainer');
                container.style.display = 'block';

                if (!player) {
                    player = new AudioPlayer('#playerContainer');
                }

                player.loadPlaylist(items);
                player.play();
            } catch (error) {
                Toast.error('فشل تشغيل القائمة');
            }
        }

        async function deletePlaylist(id) {
            Modal.confirm('هل أنت متأكد من حذف هذه القائمة؟', async () => {
                try {
                    await api.deletePlaylist(id);
                    Toast.success('تم حذف القائمة');
                    loadPlaylists();
                } catch (error) {
                    Toast.error('فشل حذف القائمة');
                }
            });
        }

        loadPlaylists();
        loadAudios();
    </script>
</body>

</html>